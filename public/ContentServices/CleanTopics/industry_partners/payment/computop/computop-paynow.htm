<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head />
    <body>Example State Machine Front-end Integration To adjust the frontend appearance, provide the following templates in your theme directory: src/&lt;project_name&gt;/Yves/Computop/Theme/&lt;custom_theme_name&gt;/paynow.twig . State Machine Integration The Computop provides a demo state machine for the PayNow payment method which implementsAuthorization/Captureflow. To enable the demo state machine, extend the configuration with the following values: &lt;?php
$config[SalesConstants::PAYMENT_METHOD_STATEMACHINE_MAPPING] = [ ... ComputopConfig::PAYMENT_METHOD_PAY_NOW =&gt; 'ComputopPayNow01',
]; $config[OmsConstants::ACTIVE_PROCESSES] = [ ... 'ComputopPayNow01', ]; Checkout Integration Add the following lines toYves\Checkout\CheckoutDependencyProvider.php $container[static::PAYMENT_METHOD_HANDLER] = function () { $paymentMethodHandler = new StepHandlerPluginCollection(); ..... $paymentMethodHandler-&gt;add(new ComputopPaymentHandlerPlugin(), PaymentTransfer::COMPUTOP_PAY_NOW); return $paymentMethodHandler;
}; $container[static::PAYMENT_SUB_FORMS] = function () { $paymentSubFormPlugin = new SubFormPluginCollection(); ..... $paymentSubFormPlugin-&gt;add(new PayNowSubFormPlugin()); return $paymentSubFormPlugin;
}; protected function provideClients(Container $container)
{ $container = parent::provideClients($container); ..... $container[static::CLIENT_COMPUTOP] = function (Container $container) { return $container-&gt;getLocator()-&gt;computop()-&gt;client(); }; return $container;
} Computop PayNow payment method also provides a new Checkout Step for filling the Credit Card data and sending it to the Computop paygate. You have to createYves/Checkout/Process/Steps/PayNowStep.phpclass with the following content: Click here to expand the code sample &lt;?php /**
* This file is part of the Spryker Demoshop.
* For full license information, please view the LICENSE file that was distributed with this source code.
*/ namespace Pyz\Yves\Checkout\Process\Steps; use Spryker\Shared\Kernel\Transfer\AbstractTransfer;
use SprykerEco\Shared\Computop\ComputopConfig; class PayNowStep extends AbstractBaseStep
{ /** * @param string $stepRoute * @param string $escapeRoute */ public function __construct( $stepRoute, $escapeRoute ) { parent::__construct($stepRoute, $escapeRoute); } /** * @param \Spryker\Shared\Kernel\Transfer\AbstractTransfer|\Generated\Shared\Transfer\QuoteTransfer $quoteTransfer * * @return bool */ public function requireInput(AbstractTransfer $quoteTransfer) { if ($this-&gt;isMethodPayNow($quoteTransfer)) { return true; } return false; } /** * @param \Spryker\Shared\Kernel\Transfer\AbstractTransfer|\Generated\Shared\Transfer\QuoteTransfer $quoteTransfer * * @return bool */ public function postCondition(AbstractTransfer $quoteTransfer) { return true; } /** * @param \Spryker\Shared\Kernel\Transfer\AbstractTransfer|\Generated\Shared\Transfer\QuoteTransfer $quoteTransfer * * @return array */ public function getTemplateVariables(AbstractTransfer $quoteTransfer) { return [ 'data' =&gt; $quoteTransfer-&gt;getPayment()-&gt;getComputopPayNow()-&gt;getData(), 'len' =&gt; $quoteTransfer-&gt;getPayment()-&gt;getComputopPayNow()-&gt;getLen(), 'merchant' =&gt; $quoteTransfer-&gt;getPayment()-&gt;getComputopPayNow()-&gt;getMerchantId(), 'action' =&gt; $quoteTransfer-&gt;getPayment()-&gt;getComputopPayNow()-&gt;getUrl(), 'brandOptions' =&gt; $this-&gt;getBrandOptions(), ]; } /** * @param \Spryker\Shared\Kernel\Transfer\AbstractTransfer|\Generated\Shared\Transfer\QuoteTransfer $quoteTransfer * * @return bool */ protected function isMethodPayNow(AbstractTransfer $quoteTransfer) { return $quoteTransfer-&gt;getPayment()-&gt;getPaymentSelection() === ComputopConfig::PAYMENT_METHOD_PAY_NOW; } /** * @return array */ protected function getBrandOptions() { return [ 'VISA' =&gt; 'Visa', 'MasterCard' =&gt; 'Master Card', 'AMEX' =&gt; 'American Express', 'DINERS' =&gt; 'Diners Club', 'JCB' =&gt; 'JCB', 'CBN' =&gt; 'CBN', 'SWITCH' =&gt; 'Switch', 'SOLO' =&gt; 'Solo', ]; }
} Then you need to add it toYves/Checkout/Process/StepFactory.phpright after thePlaceOrderstep and before theSuccessstep. protected function createPayNowStep()
{ return new PayNowStep( CheckoutControllerProvider::CHECKOUT_COMPUTOP_PAYNOW, ApplicationControllerProvider::ROUTE_HOME );
} public function createStepCollection()
{ $stepCollection = new StepCollection( $this-&gt;getUrlGenerator(), CheckoutControllerProvider::CHECKOUT_ERROR ); $stepCollection .... -&gt;addStep($this-&gt;createPlaceOrderStep()) -&gt;addStep($this-&gt;createPayNowStep()) -&gt;addStep($this-&gt;createSuccessStep()); return $stepCollection;
} Also you need to add action toYves/Checkout/Controller/CheckoutController.php public function paynowAction(Request $request)
{ return $this-&gt;createStepProcess()-&gt;process($request);
} And define this action inYves/Checkout/Plugin/Provider/CheckoutControllerProvider.php protected function defineControllers(Application $app)
{ $allowedLocalesPattern = $this-&gt;getAllowedLocalesPattern(); ..... $this-&gt;createController('/{checkout}/computop/paynow', self::CHECKOUT_COMPUTOP_PAYNOW, 'Checkout', 'Checkout', 'paynow') -&gt;assert('checkout', $allowedLocalesPattern . 'checkout|checkout') -&gt;value('checkout', 'checkout') -&gt;method('GET|POST');
} The final step is to create a template for renderingPayNowstep inYves/Checkout/Theme/default/checkout/paynow.twig Click here to expand the code sample {% extends "@checkout/layout.twig" %} {% block breadcrumb %}{% endblock %} {% block content %}
&lt;div class="row columns"&gt; &lt;form name="paynowStepForm" method="post" action="{{ action }}"&gt; &lt;div id="paynowStepForm" class="callout"&gt; &lt;div class="small-12 large-6 columns"&gt; &lt;div&gt; &lt;label for="paynowStepForm_CCBrand" class="required"&gt;Credit Card Brand&lt;/label&gt; &lt;select id="paynowStepForm_CCBrand" name="CCBrand"&gt; {% for key, value in brandOptions %} &lt;option value="{{ key }}"&gt;{{ value }}&lt;/option&gt; {% endfor %} &lt;/select&gt; &lt;/div&gt; &lt;div&gt; &lt;label for="paynowStepForm_CCNr" class="required"&gt;Credit Card Number&lt;/label&gt; &lt;input type="text" id="paynowStepForm_CCNr" name="CCNr" required="required"&gt; &lt;/div&gt; &lt;div&gt; &lt;label for="paynowStepForm_CCExpiry" class="required"&gt;Credit card expiry date in the format YYYYMM, e.g. 201807&lt;/label&gt; &lt;input type="text" id="paynowStepForm_CCExpiry" name="CCExpiry" required="required"&gt; &lt;/div&gt; &lt;div&gt; &lt;label for="paynowStepForm_CCCVC" class="required"&gt;CVV&lt;/label&gt; &lt;input type="text" id="paynowStepForm_CCCVC" name="CCCVC" required="required"&gt; &lt;/div&gt; &lt;input type="hidden" id="paynowStepForm_MerchantID" name=""MerchantID" value="{{ merchant }}"&gt; &lt;input type="hidden" id="paynowStepForm_Data" name="Data" value="{{ data }}"&gt; &lt;input type="hidden" id="paynowStepForm_Len" name="Len" value="{{ len }}"&gt; &lt;input type="hidden" id="paynowStepForm__token" name="paynowStepForm[_token]" value="QU3KalLrQ3pyUPPNc13NzPQ5U4O_vdjK5gkPKR5pkEo"&gt; &lt;div class="row align-right"&gt; &lt;div class="small-12 medium-6 large-4 xlarge-6 columns"&gt; &lt;button type="submit" class="button success expanded __no-margin-bottom"&gt;Pay&lt;/button&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/form&gt;
&lt;/div&gt;
{% endblock %} To make this specific step work only with PayNow payment method we have to updateYves/Checkout/Process/Steps/PlaceOrderStep.php public function execute(Request $request, AbstractTransfer $quoteTransfer)
{ if ($this-&gt;isPaymentPayNow($quoteTransfer) &amp;&amp; $this-&gt;isComputopPaymentExist($quoteTransfer)) { return $quoteTransfer; } $quoteTransfer = parent::execute($request, $quoteTransfer); if ($this-&gt;isPaymentPayNow($quoteTransfer)) { $this-&gt;setComputopInitData($quoteTransfer); } return $quoteTransfer;
} protected function isPaymentPayNow(QuoteTransfer $quoteTransfer)
{ return $quoteTransfer-&gt;getPayment()-&gt;getPaymentSelection() === ComputopConfig::PAYMENT_METHOD_PAY_NOW;
} protected function isComputopPaymentExist(QuoteTransfer $quoteTransfer)
{ $quoteTransfer = $this-&gt;computopClient-&gt;isComputopPaymentExist($quoteTransfer); return (bool)$quoteTransfer-&gt;getPayment()-&gt;getIsComputopPaymentExist();
} Also, you will need to addComputopClienttoPlaceOrderSpetdependecyYves/Checkout/Process/StepFactory.php public function getComputopClient()
{ return $this-&gt;getProvidedDependency(CheckoutDependencyProvider::CLIENT_COMPUTOP);
} protected function createPlaceOrderStep()
{ return new PlaceOrderStep( $this-&gt;getCheckoutClient(), $this-&gt;getFlashMessenger(), $this-&gt;getComputopClient(), CheckoutControllerProvider::CHECKOUT_PLACE_ORDER, ApplicationControllerProvider::ROUTE_HOME, [ 'payment failed' =&gt; CheckoutControllerProvider::CHECKOUT_PAYMENT, ShipmentCheckoutConnectorConfig::ERROR_CODE_SHIPMENT_FAILED =&gt; CheckoutControllerProvider::CHECKOUT_SHIPMENT, ] );
} PayNow Payment Flow: There is a radio button onPaymentstep. After submitting the order, the customer is redirected to the to PayNow checkout step. The step contains Credit Card form with the following fields: Credit Card brand choice; Credit Card number; Credit Card expires date (in the formatYYYYMM, e.g. 201807); Credit Card security code (CVV); Data (hidden field, encrypted parameters, e.g. currency, amount, description); Length (hidden field, length ofdataparameter); Merchant id (hidden field, assigned by Computop). Form posts directly to Computop paygate. After the process is requested, Computop redirects the customer to success or failure URL. By default, on success the customer will be redirected to "Success" step. The response containspayId. On error, the customer will be redirected to "Payment" step with the error message. Response data is stored in the DB. Authorization is added by default right after the success init action. Capture/Refund and Cancel actions are implemented in the Administration Interface (on manage order). On requests, Spryker will usepayIdparameter stored in the DB to identify a payment. See also: Get a general idea about Computop Learn about Computop API Get acquainted with Computop OMS functioning Configure Credit Card payment method for Computop Configure Direct Debit payment method for Computop Configure Easy Credit payment method for Computop Configure iDeal payment method for Computop Configure Paydirekt payment method for Computop Configure PayPal payment method for Computop Cnfigure Sofort payment method for Computop Last review date: Jun. 14th, 2018</body>
</html>