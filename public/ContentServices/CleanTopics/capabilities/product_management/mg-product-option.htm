<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head />
    <body>Upgrading from Version 5.* to Version 6.* Updatespryker/product-optionto at least version 6.0.0. Install/Updatespryker/currencyto at least version 3.0.0. You can find additional information to currency module upgrade: here . Install/Updatespryker/priceto at least version 5.0.0. Updatespryker/product-option-cart-connectorto at least version 5.0.0 (if you have this module already installed). You can find additional information to product option cart connector module upgrade: here . Install the new database tables by runningvendor/bin/console propel:diff. Propel should generate a migration file with the changes. Runvendor/bin/console propel:migrateto apply the database changes. Generate ORM models by runningvendor/bin/console propel:model:build. This command will generate some new classes in your project under\Orm\Zed\ProductOption\Persistencenamespace. It is important to make sure that they extend the base classes from the Spryker core, e.g.: \Orm\Zed\ProductOption\Persistence\SpyProductOptionValuePriceextends\Spryker\Zed\ProductOption\Persistence\Propel\AbstractSpyProductOptionValuePrice \Orm\Zed\ProductOption\Persistence\SpyProductOptionValuePriceQueryextends\Spryker\Zed\ProductOption\Persistence\Propel\AbstractSpyProductOptionValuePriceQuery Runvendor/bin/console transfer:generateto generate the new transfer objects. Make sure the new Zed user interface assets are built by runningnpm run zed(or antelope build Zed for older versions). RegisterMoneyCollectionFormTypePluginin product option dependency provider to support multi-currency price configuration in Zed Admin UI. Example of plugin registration: &lt;?php
namespace Pyz\Zed\ProductOption; use Spryker\Zed\Kernel\Container;
use Spryker\Zed\Money\Communication\Plugin\Form\MoneyCollectionFormTypePlugin;
use Spryker\Zed\ProductOption\ProductOptionDependencyProvider as SprykerProductOptionDependencyProvider; class ProductOptionDependencyProvider extends SprykerProductOptionDependencyProvider
{ /** * @param \Spryker\Zed\Kernel\Container $container * * @return \Spryker\Zed\Kernel\Communication\Form\FormTypeInterface */ protected function createMoneyCollectionFormTypePlugin(Container $container) { return new MoneyCollectionFormTypePlugin(); }
} Migrate prices fromspy_product_option_value.pricefield tospy_product_option_value_pricetable. Eachspy_product_option_valuerow must have at least 1spy_product_option_value_pricerow connected. AProductOptionValueentity can have multipleProductOptionValuePricesconnected. You can define different gross/net price per currency per store by populating thefk_currencyandfk_storefields accordingly. When eithergross_priceornet_pricedatabase field is left asnull, that option will not be available for customers in that exact currency, store, price mode trio. If you set a price field as0, the option is available for customers and it means it is free of charge. Example of migration &lt;?php
/** * Copyright © 2016-present Spryker Systems GmbH. All rights reserved. * Use of this software requires acceptance of the Evaluation License Agreement. See LICENSE file. */ namespace Spryker\Zed\ProductOption\Communication\Console; use Orm\Zed\Product\Persistence\SpyProductAbstractQuery;
use Orm\Zed\ProductOption\Persistence\Base\SpyProductOptionValue;
use Orm\Zed\ProductOption\Persistence\SpyProductOptionValuePrice;
use Orm\Zed\ProductOption\Persistence\SpyProductOptionValuePriceQuery;
use Orm\Zed\ProductOption\Persistence\SpyProductOptionValueQuery;
use Spryker\Zed\Kernel\Communication\Console\Console;
use Spryker\Zed\ProductOption\ProductOptionConfig;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\Question\ConfirmationQuestion; /** * @method \Spryker\Zed\ProductOption\Communication\ProductOptionCommunicationFactory getFactory() */
class MigrateProductOptionValuePricesConsole extends Console
{ const COMMAND_NAME = 'product-option:price:migrate'; const COMMAND_DESCRIPTION = 'Console command to migrate product option value prices to multi currency implementation.'; /** * @var int[] Keys are currency iso codes, values are currency ids. */ protected static $idCurrencyCache = []; /** * @return void */ protected function configure() { $this-&gt;setName(static::COMMAND_NAME); $this-&gt;setDescription(static::COMMAND_DESCRIPTION); parent::configure(); } /** * @param \Symfony\Component\Console\Input\InputInterface $input * @param \Symfony\Component\Console\Output\OutputInterface $output * * @return void */ protected function execute(InputInterface $input, OutputInterface $output) { $storeTransferCollection = $this-&gt;getFactory()-&gt;getStoreFacade()-&gt;getAllStores(); $productOptionCollection = SpyProductOptionValueQuery::create()-&gt;find(); if (count($productOptionCollection) === 0) { $output-&gt;writeln('There are no product option values to migrate.'); return; } if (count($storeTransferCollection) === 0) { $output-&gt;writeln('There are no stores set up to migrate.'); return; } $question = new ConfirmationQuestion( sprintf('Migrate %s product option values? (y|n)', count($productOptionCollection)), false ); if (!$this-&gt;getQuestionHelper()-&gt;ask($input, $output, $question)) { $output-&gt;writeln('Aborted.'); return; } $storeCurrencies = $this-&gt;getStoreCurrencies($storeTransferCollection); $defaultIdStore = $this-&gt;getDefaultIdStore(); $defaultIdCurrency = $this-&gt;getDefaultIdCurrency(); foreach ($productOptionCollection as $productOptionEntity) { $this-&gt;processProductOption($productOptionEntity, $storeCurrencies, $defaultIdStore, $defaultIdCurrency); $this-&gt;touchRelatedProductAbstracts($productOptionEntity-&gt;getIdProductOptionValue()); $output-&gt;writeln(sprintf('Product option value %d is migrated.', $productOptionEntity-&gt;getIdProductOptionValue())); } $output-&gt;writeln('done.'); } /** * @param \Orm\Zed\ProductOption\Persistence\Base\SpyProductOptionValue $productOptionValueEntity * @param array $storeCurrencies * @param int $defaultIdStore * @param int $defaultIdCurrency * * @return void */ protected function processProductOption(SpyProductOptionValue $productOptionValueEntity, array $storeCurrencies, $defaultIdStore, $defaultIdCurrency) { foreach ($storeCurrencies as list($idStore, $idCurrency)) { $productOptionValuePriceEntity = SpyProductOptionValuePriceQuery::create() -&gt;filterByFkProductOptionValue($productOptionValueEntity-&gt;getIdProductOptionValue()) -&gt;filterByFkStore($idStore) -&gt;filterByFkCurrency($idCurrency) -&gt;findOneOrCreate(); $isDefaultStoreCurrency = $idStore === $defaultIdStore &amp;&amp; $idCurrency === $defaultIdCurrency; $this-&gt;setNetPrice($productOptionValuePriceEntity); $this-&gt;setGrossPrice($productOptionValuePriceEntity, $productOptionValueEntity, $isDefaultStoreCurrency); $productOptionValuePriceEntity-&gt;save(); } } /** * @param \Orm\Zed\ProductOption\Persistence\SpyProductOptionValuePrice $productOptionValuePriceEntity * * @return void */ protected function setNetPrice(SpyProductOptionValuePrice $productOptionValuePriceEntity) { if ($productOptionValuePriceEntity-&gt;getNetPrice() !== null) { return; } } /** * @param \Orm\Zed\ProductOption\Persistence\SpyProductOptionValuePrice $productOptionValuePriceEntity * @param \Orm\Zed\ProductOption\Persistence\Base\SpyProductOptionValue $productOptionValue * @param bool $isDefaultStoreCurrency * * @return void */ protected function setGrossPrice(SpyProductOptionValuePrice $productOptionValuePriceEntity, SpyProductOptionValue $productOptionValue, $isDefaultStoreCurrency) { if ($productOptionValuePriceEntity-&gt;getGrossPrice() !== null) { return; } $productOptionValuePriceEntity-&gt;setGrossPrice($isDefaultStoreCurrency ? (int)$productOptionValue-&gt;getPrice() : null); } /** * @param int $idProductOptionValue * * @return void */ protected function touchRelatedProductAbstracts($idProductOptionValue) { $productAbstractCollection = SpyProductAbstractQuery::create() -&gt;joinSpyProductAbstractProductOptionGroup() -&gt;useSpyProductAbstractProductOptionGroupQuery() -&gt;joinSpyProductOptionGroup() -&gt;useSpyProductOptionGroupQuery() -&gt;joinSpyProductOptionValue() -&gt;useSpyProductOptionValueQuery() -&gt;filterByIdProductOptionValue($idProductOptionValue) -&gt;endUse() -&gt;endUse() -&gt;endUse() -&gt;find(); foreach ($productAbstractCollection as $productAbstractEntity) { $this-&gt;getFactory() -&gt;getTouchFacade() -&gt;touchActive( ProductOptionConfig::RESOURCE_TYPE_PRODUCT_OPTION, $productAbstractEntity-&gt;getIdProductAbstract() ); } } /** * Returns with a list of available store-currency id pairs. * * Example: * Store 1 has currency 5, 6 * Store 2 has currency 10 * Result: [ * [1, 5], * [1, 6], * [2, 10] * ] * * @param \Generated\Shared\Transfer\StoreTransfer[] $storeTransferCollection * * @return array */ protected function getStoreCurrencies(array $storeTransferCollection) { $currencies = []; foreach ($storeTransferCollection as $storeTransfer) { foreach ($storeTransfer-&gt;getAvailableCurrencyIsoCodes() as $isoCode) { $currencies[] = [$storeTransfer-&gt;getIdStore(), $this-&gt;getIdCurrencyByIsoCode($isoCode)]; } } return $currencies; } /** * @param string $currencyIsoCode * * @return int */ protected function getIdCurrencyByIsoCode($currencyIsoCode) { if (!isset(static::$idCurrencyCache[$currencyIsoCode])) { static::$idCurrencyCache[$currencyIsoCode] = $this-&gt;getFactory() -&gt;getCurrencyFacade() -&gt;fromIsoCode($currencyIsoCode) -&gt;getIdCurrency(); } return static::$idCurrencyCache[$currencyIsoCode]; } /** * @return int */ protected function getDefaultIdCurrency() { return $this-&gt;getIdCurrencyByIsoCode( $this-&gt;getFactory() -&gt;getStoreFacade() -&gt;getCurrentStore() -&gt;getDefaultCurrencyIsoCode() ); } /** * @return int */ protected function getDefaultIdStore() { return $this-&gt;getFactory()-&gt;getStoreFacade()-&gt;getCurrentStore()-&gt;getIdStore(); } /** * @return \Symfony\Component\Console\Helper\QuestionHelper */ protected function getQuestionHelper() { return $this-&gt;getHelper('question'); }
} The product option collector has to be amended to support multi-currency prices on product option values. The Storage has to save all product option value prices within a given store using the new Storage data structure: { "idProductOptionValue": 1, "sku": "OP_1_year_warranty", "prices": { "CHF": { "GROSS_MODE": { "amount": 600 }, "NET_MODE": { "amount": null } }, "EUR": { "GROSS_MODE": { "amount": 800 }, "NET_MODE": { "amount": 900 } } }, "value": "product.option.warranty_1" }, A new API call was added to get the store specific prices back:ProductOptionFacadeInterface::getProductOptionValueStorePrices(). Example of collector upgrade &lt;?php
namespace Pyz\Zed\Collector\Business\Storage; use ArrayObject;
use Generated\Shared\Transfer\MoneyValueTransfer;
use Generated\Shared\Transfer\ProductOptionValueStorePricesRequestTransfer; class ProductOptionCollector extends Spryker\Zed\Collector\Business\Collector\Storage\AbstractStoragePdoCollector
{ /** * @var \Spryker\Zed\ProductOption\Business\ProductOptionFacadeInterface */ protected $productOptionFacade; ... /** * @param \Orm\Zed\ProductOption\Persistence\SpyProductOptionGroup $productOptionGroupEntity * * @return array */ protected function getOptionGroupValues(SpyProductOptionGroup $productOptionGroupEntity) { $optionValues = []; foreach ($productOptionGroupEntity-&gt;getSpyProductOptionValues() as $optionValueEntity) { $optionValues[] = [ StorageProductOptionValueTransfer::ID_PRODUCT_OPTION_VALUE =&gt; $optionValueEntity-&gt;getIdProductOptionValue(), StorageProductOptionValueTransfer::SKU =&gt; $optionValueEntity-&gt;getSku(), StorageProductOptionValueTransfer::PRICES =&gt; $this-&gt;getPrices($optionValueEntity-&gt;getProductOptionValuePrices()), StorageProductOptionValueTransfer::VALUE =&gt; $optionValueEntity-&gt;getValue(), ]; } return $optionValues; } /** * @param \Propel\Runtime\Collection\ObjectCollection|\Orm\Zed\ProductOption\Persistence\SpyProductOptionValuePrice[] $objectCollection * * @return array */ protected function getPrices(ObjectCollection $objectCollection) { $moneyValueCollection = $this-&gt;transformPriceEntityCollectionToMoneyValueTransferCollection($objectCollection); $priceResponse = $this-&gt;productOptionFacade-&gt;getProductOptionValueStorePrices( (new ProductOptionValueStorePricesRequestTransfer())-&gt;setPrices($moneyValueCollection) ); return $priceResponse-&gt;getStorePrices(); } /** * @param \Propel\Runtime\Collection\ObjectCollection|\Orm\Zed\ProductOption\Persistence\SpyProductOptionValuePrice[] $priceEntityCollection * * @return \ArrayObject|\Generated\Shared\Transfer\MoneyValueTransfer[] */ protected function transformPriceEntityCollectionToMoneyValueTransferCollection(ObjectCollection $priceEntityCollection) { $moneyValueCollection = new ArrayObject(); foreach ($priceEntityCollection as $productOptionValuePriceEntity) { $moneyValueCollection-&gt;append( (new MoneyValueTransfer()) -&gt;fromArray($productOptionValuePriceEntity-&gt;toArray(), true) -&gt;setNetAmount($productOptionValuePriceEntity-&gt;getNetPrice()) -&gt;setGrossAmount($productOptionValuePriceEntity-&gt;getGrossPrice()) ); } return $moneyValueCollection; }
} Transfer objects were amended to support multi-currency price storage. Check your customized codes for the following fields to apply the new behavior: ProductOptionValuetransfer object's price field is replaced by prices field which contains a collection ofMoneyValuetransfer objects to support multi-currency behaviour. This field can not be used directly anymore to display a price to customer in Yves. StorageProductOptionValuetransfer object contains a "prices" field which contains prices within a specific store for all currencies and price modes. StorageProductOptionValuetransfer object's price field now represents a price for a given store, currency, and price mode trio. The following public API elements were changed, check your custom calls to them: ProductOptionFacadeInterface::getProductOptionGroupById()populates all multi-currency prices instead of the singular price. ProductOptionFacadeInterface::getProductOptionValueById()sets both net and gross prices for the current store and current currency. ProductOptionFacadeInterface::saveProductOptionValue()saves multi-currency prices instead of a single price and expects new data structure accordingly. ProductOptionFacadeInterface::saveProductOptionGroup()saves multi-currency prices instead of a single price and expects new data structure accordingly. ProductOptionClientInterface::getProductOptions()uses the modifiedStorageProductOptionValuetransfer, selects a multi-currency price. ProductOptionQueryContainer::queryProductOptionGroupWithValues()is removed without replacement. ProductOptionQueryContainerInterface::queryProductsAbstractBySearchTerm()is removed from public API and now it's a protected method. ProductOptionToTaxInterface::getTaxAmountFromGrossPrice()is removed. ProductOptionToMoneyInterface::convertIntegerToDecimal()is removed. ProductOptionToMoneyInterface::fromFloat()is removed. ProductOptionToMoneyInterface::fromString()is removed. ProductOptionFacadeInterface::toggleOptionActive()expects 1st argument to be int. ProductOptionCommunicationFactory::createProductOptionGroup()does not accept null argument anymore. ProductOptionDependencyProvider's constants are refactored. Client dependency interfaces are renamed (postfixed with "Client"). Zed dependency interfaces are renamed (postfixed with the corresponding layer name). Some additional changes that might have effect on you if you have customized any of these classes directly or their factory method: AbstractProductOptionSaver ProductOptionGroupReader ProductOptionListTable ProductOptionStorage ProductOptionTaxRateCalculator ProductOptionValueForm ProductOptionValueReader ProductOptionValueSaver Verify your product option value prices on Zed Admin UI Product Options page. Upgrading From version 4.* To Version 5.* In version 5 Product Options were updated to work with the new calculator concept. Therefore, the SalesAggregator plugin was moved to the SalesAggregator moduleSubtotalWithProductOptionsAggregatorPlugin. The sales option database tables received new columns for storing calculated values. To learn how to migrate to new structure see, Upgrading from Version 3.* to Version 4.* See also: Learn how to migrate Currency Learn how to migrate Product Option Cart Connector Last review date: Nov. 10th, 2017</body>
</html>