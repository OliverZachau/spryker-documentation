<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" lang="en-us" xml:lang="en-us" class="_Skins_HTML5___Top_Navigation" data-mc-search-type="Stem" data-mc-help-system-file-name="Default.xml" data-mc-path-to-help-system="../../../../" data-mc-has-content-body="True" data-mc-conditions="Spryker.DemoShop,Spryker.B2C,Spryker.B2B" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic;Default" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-toc-path="Industry Partners|Industry Partners|Payment Integration - Billpay">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta charset="utf-8" />
        <meta name="description" content="" />
        <meta name="author" content="" /><title>Billpay - Invoice Payment in Preauthorize Mode</title>
        <link href="../../../../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" />
        <link href="../../../../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" />
        <link href="../../../../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" />
        <link href="../../../../Skins/Fluid/Stylesheets/MadCapSearch.Google.css" rel="stylesheet" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Tablet.css" rel="stylesheet" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Mobile.css" rel="stylesheet" />
        <link href="../../../../Skins/Fluid/stylesheets/foundation.6.2.3.css" rel="stylesheet" />
        <link href="../../../../Skins/Fluid/stylesheets/styles.css" rel="stylesheet" />
        <link href="../../../../Skins/Fluid/stylesheets/tablet.css" rel="stylesheet" />
        <link href="../../../../Skins/Fluid/stylesheets/mobile.css" rel="stylesheet" />
        <link href="../../../resources/stylesheets/prism.css" rel="stylesheet" />
        <style>/*&lt;meta /&gt;*/

.button.topic-ratings-button
{
	-pie-background: transparent url('../../../../Skins/Default/Stylesheets/Images/star-full.png') no-repeat center center;
}

.button.separator-button
{
	-pie-background: linear-gradient(#ffffff, #ececec);
}

.button.edit-user-profile-button
{
	-pie-background: url('../../../../Skins/Default/Stylesheets/Images/edit-profile.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.print-button
{
	-pie-background: url('../../../../Skins/Default/Stylesheets/Images/printer.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.expand-all-button
{
	-pie-background: url('../../../../Skins/Default/Stylesheets/Images/expand.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.collapse-all-button
{
	-pie-background: url('../../../../Skins/Default/Stylesheets/Images/collapse.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.needs-pie
{
	behavior: url('../../../../Resources/Scripts/PIE-no-motw.htc');
}

</style>
        <link href="../../../resources/stylesheets/mainstyles.css" rel="stylesheet" />
        <link href="../../../resources/tablestyles/patternedrows.css" rel="stylesheet" />
        <script src="../../../../Resources/Scripts/custom.modernizr.js">
        </script>
        <script src="../../../../Resources/Scripts/jquery.min.js">
        </script>
        <script src="../../../../Resources/Scripts/require.min.js">
        </script>
        <script src="../../../../Resources/Scripts/require.config.js">
        </script>
        <script src="../../../../Resources/Scripts/foundation.6.2.3_custom.js">
        </script>
        <script src="../../../../Resources/Scripts/plugins.min.js">
        </script>
        <script src="../../../../Resources/Scripts/MadCapAll.js">
        </script>
        <script src="../../../../Resources/Scripts/MadCapSearch.Google.js">
        </script>
    </head>
    <body>
        <div class="foundation-wrap off-canvas-wrapper">
            <div class="off-canvas-wrapper-inner" data-off-canvas-wrapper="">
                <aside class="off-canvas position-right" id="offCanvas" data-off-canvas="" data-position="right" data-mc-ignore="true">
                    <ul class="off-canvas-drilldown vertical menu off-canvas-list" data-drilldown="" data-mc-back-link="Back" data-mc-css-tree-node-expanded="is-drilldown-submenu-parent" data-mc-css-tree-node-collapsed="is-drilldown-submenu-parent" data-mc-css-sub-menu="vertical menu slide-in-right is-drilldown-submenu" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="True" data-mc-include-back="True" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.drilldown" data-mc-toc="True">
                    </ul>
                </aside>
                <div class="off-canvas-content inner-wrap" data-off-canvas-content="">
                    <div data-sticky-container="" class="title-bar-container">
                        <nav class="title-bar tab-bar sticky" data-sticky="" data-options="marginTop:0" style="width:100%" data-sticky-on="small" data-mc-ignore="true">
                            <div class="middle title-bar-section outer-row clearfix">
                                <div class="menu-icon-container relative clearfix">
                                    <button class="menu-icon" data-toggle="offCanvas"><span></span>
                                    </button>
                                </div>
                            </div>
                            <div class="title-bar-layout outer-row">
                                <div class="logo-wrapper"><a class="logo" href="../../../home.htm" alt="Logo"></a>
                                </div>
                                <div class="navigation-wrapper nocontent">
                                    <ul class="navigation clearfix" data-mc-css-tree-node-has-children="has-children" data-mc-css-sub-menu="sub-menu" data-mc-expand-event="mouseenter" data-mc-top-nav-menu="True" data-mc-max-depth="3" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                        <li class="placeholder" style="visibility:hidden"><a>placeholder</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="nav-search-wrapper">
                                    <div class="nav-search row">
                                        <form>
                                            <div id="vWBl_yQF3k-8fbqzyH6cxg" class="search-bar search-bar-container needs-pie">
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </nav>
                    </div>
                    <section class="main-section">
                        <div class="row outer-row sidenav-layout">
                            <div class="sidenav-wrapper">
                                <div class="sidenav-container">
                                    <ul class="off-canvas-accordion vertical menu sidenav" data-accordion-menu="" data-mc-css-tree-node-expanded="is-accordion-submenu-parent" data-mc-css-tree-node-collapsed="is-accordion-submenu-parent" data-mc-css-sub-menu="vertical menu accordion-menu is-accordion-submenu nested" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="False" data-mc-include-back="False" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.accordionMenu" data-mc-toc="True" data-mc-side-nav-menu="True">
                                    </ul>
                                </div>
                            </div>
                            <div class="body-container" data-mc-content-body="True">
                                <script src="../../../resources/prism.js">
                                </script>
                                <div class="search-container">
                                    <form>
                                        <div id="jaCI76h4YEe2uMCk9OcjpQ" class="search-bar search-bar-container needs-pie _Skins_SearchTopics mc-component">
                                        </div>
                                    </form>
                                </div>
                                <div class="row collapse">
                                    <div class="top-bar">
                                        <div class="nocontent">
                                            <div class="MCBreadcrumbsBox_0 breadcrumbs" data-mc-breadcrumbs-divider=" &gt; " data-mc-breadcrumbs-count="3" data-mc-toc="True"><span class="MCBreadcrumbsPrefix">You are here: </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="topic-layout">
                                        <div>
                                            <div class="side-menu">
                                                <div data-sticky-container="" id="DMWF2y482UenxOXYT0CrWQ">
                                                    <div class="sticky sticky-menu" style="width:100%" data-sticky="" data-top-anchor="DMWF2y482UenxOXYT0CrWQ:top" data-bottom-anchor="contentBody:bottom" data-sticky-on="small" data-scroll-container-on="small">
                                                        <ul class="nocontent menu _Skins_SideMenu mc-component" data-mc-is-context-sensitive="True" data-mc-linked-toc="Data/Tocs/master.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="side-menu">
                                                <div class="buttons popup-container clearfix topicToolbarProxy _Skins_TopicToolbar mc-component nocontent" style="mc-topic-toolbar-items: ;">
                                                    <div class="button-group-container-left">
                                                        <div class="button-group star-buttons loading feedback-topic-required">
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                        </div>
                                                        <div class="button-separator feedback-topic-required">
                                                        </div>
                                                        <button class="button feedback-required login-button" id="normalLoginBtn" data-state1-class="login-button" data-state2-class="edit-user-profile-button" title="Login" data-state1-title="Login">
                                                            <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="login" />
                                                        </button>
                                                        <button class="button needs-pie print-button" title="Print">
                                                            <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="print" />
                                                        </button>
                                                        <button class="button needs-pie expand-all-button" data-state1-class="expand-all-button" data-state2-class="collapse-all-button" data-state2-title="Collapse all" title="Expand all" data-state1-title="Expand all">
                                                            <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="expand all" />
                                                        </button>
                                                    </div>
                                                </div>
                                                <h1>Billpay - Invoice Payment in Preauthorize Mode <img src="../../../resources/images/shoptype/b2b_shop.png" /> <img src="../../../resources/images/shoptype/b2c_shop.png" /> <img src="../../../resources/images/shoptype/demoshop.png" /></h1>
                                                <p class="note">Refer to Billpay payment information (<a href="https://www.billpay.de/en/business-clients/payment-information/" target="_blank">https://www.billpay.de/en/business-clients/payment-information/</a>) for information about payment methods.</p>
                                                <p>The identity and credit check are checked within a single "pre-authorize" call after summary page was submitted.
           This may lead to the “rejection” of the order.</p>
                                                <p>To switch to the authorize mode, <b>switch Billpay configuration variables</b> to "pre-authorize" set of configuration variables:</p><pre><code class="language-php line-numbers">&lt;?php
b/config/Shared/config_default.php
@@ -364,19 +364,19 @@ $config[TaxConstants::DEFAULT_TAX_RATE] = 19;

...

+//$config[BillpayConstants::BILLPAY_PORTAL_ID] = '[your prescore id e.g. 8111]';//prescore
+//$config[BillpayConstants::BILLPAY_SECURITY_KEY] = '[your prescore security key]';//prescore

+$config[BillpayConstants::BILLPAY_PORTAL_ID] = '[your pre-authorize id e.g. 8112]';//pre-authorize
+$config[BillpayConstants::BILLPAY_SECURITY_KEY] = '[your pre-authorize security key]';//pre-authorize
....
-$config[BillpayConstants::USE_PRESCORE] = 1;
+$config[BillpayConstants::USE_PRESCORE] = 0;


            </code></pre>
                                                <h2>Billpay Invoice Payment with Prescoring</h2>
                                                <p>Using the “prescore” scoring model, the identity and credit check is performed before the payment method is selected. The results of the check are then used to display or hide the available payment methods accordingly. This eliminates the negative purchasing experience of a “rejection”.</p>
                                                <h3>Configuration </h3>
                                                <p>To switch to the authorize mode, <b>switch Billpay configuration variables</b> to "pre-score" set of the configuration variables:</p><pre><code class="language-php line-numbers">&lt;?php
b/config/Shared/config_default.php
@@ -364,19 +364,19 @@ $config[TaxConstants::DEFAULT_TAX_RATE] = 19;

...

+$config[BillpayConstants::BILLPAY_PORTAL_ID] = '[your prescore id e.g. 8111]';//prescore
+$config[BillpayConstants::BILLPAY_SECURITY_KEY] = '[your prescore security key]';//prescore

+//$config[BillpayConstants::BILLPAY_PORTAL_ID] = '[your pre-authorize id e.g. 8112]';//pre-authorize
+//$config[BillpayConstants::BILLPAY_SECURITY_KEY] = '[your pre-authorize security key]';//pre-authorize
....
+$config[BillpayConstants::USE_PRESCORE] = 1;
-$config[BillpayConstants::USE_PRESCORE] = 0;


            </code></pre>
                                                <h3>Yves </h3>
                                                <h4>Customer Setup</h4>
                                                <p>In Yves  <var>CustomerStep</var> needs to be extended by calling the <var>BillpayCustomerHandlerPlugin</var>:</p><pre><code class="language-php line-numbers">&lt;?php
/**
     * Update QuoteTransfer with customer step handler plugin.
     *
     * @param \Symfony\Component\HttpFoundation\Request $request
     * @param \Spryker\Shared\Kernel\Transfer\AbstractTransfer|\Generated\Shared\Transfer\QuoteTransfer $quoteTransfer
     *
     * @return \Generated\Shared\Transfer\QuoteTransfer
     */
    public function execute(Request $request, AbstractTransfer $quoteTransfer)
    {
        $this-&gt;customerStepHandler-&gt;get(CheckoutDependencyProvider::CUSTOMER_STEP_HANDLER)-&gt;addToDataClass($request, $quoteTransfer);
        $this-&gt;customerStepHandler-&gt;get(BillpayConstants::PAYMENT_METHOD_INVOICE)-&gt;addToDataClass($request, $quoteTransfer);

        return $quoteTransfer;
    }</code></pre>
                                                <p>Next, extend the <var>CheckoutDependencyProvider </var>to return the <var>StepHandlerPluginCollection</var>:</p><pre><code class="language-php line-numbers">&lt;?php
  /**
     * @param \Spryker\Yves\Kernel\Container $container
     *
     * @return \Spryker\Yves\Kernel\Container
     */
    protected function providePlugins(Container $container)
    {
        parent::providePlugins($container);

        $container[self::PLUGIN_CUSTOMER_STEP_HANDLER] = function () {
            $plugins = new StepHandlerPluginCollection();
            $plugins-&gt;add(new BillpayCustomerHandlerPlugin(), BillpayConstants::PAYMENT_METHOD_INVOICE);
            $plugins-&gt;add(new CustomerStepHandler(), self::CUSTOMER_STEP_HANDLER);
            return $plugins;
        };</code></pre>
                                                <p>Lastly, change the <var>CustomerStep </var>constructor:</p><pre><code class="language-php line-numbers">&lt;?php
 /**
     * @param \Pyz\Client\Customer\CustomerClientInterface $customerClient
     * @param \Spryker\Yves\StepEngine\Dependency\Plugin\Handler\StepHandlerPluginCollection $customerStepHandler
     * @param string $stepRoute
     * @param string $escapeRoute
     */
    public function __construct(
        CustomerClientInterface $customerClient,
        StepHandlerPluginCollection $customerStepHandler,
        $stepRoute,
        $escapeRoute
    ) {
        parent::__construct($stepRoute, $escapeRoute);

        $this-&gt;customerClient = $customerClient;
        $this-&gt;customerStepHandler = $customerStepHandler;
    }</code></pre>
                                                <h4>Shipment Step</h4>
                                                <p>One of the places we can call prescore is the shipment step. </p>
                                                <p>At this point, the checkout process can provide us with all the information we need to do prescoring. </p>
                                                <p>To do prescoring, add the Billpay client to Shippment step by modifying the StepFactory:</p><pre><code class="language-php line-numbers">&lt;?php
 /**
     * @return \Pyz\Yves\Checkout\Process\Steps\ShipmentStep
     */
    protected function createShipmentStep()
    {
        return new ShipmentStep(
            $this-&gt;getCalculationClient(),
            $this-&gt;getProvidedDependency(CheckoutDependencyProvider::CLIENT_BILLPAY),
            $this-&gt;createShipmentPlugins(),
            CheckoutControllerProvider::CHECKOUT_SHIPMENT,
            ApplicationControllerProvider::ROUTE_HOME
        );
    }</code></pre>
                                                <p>Then register the client in <var>CheckoutDependencyProvider</var>.</p>
                                                <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Click here to expand the code sample</a></span>
                                                    <div class="MCDropDownBody dropDownBody"><pre><code class="language-php line-numbers">&lt;?php

/src/Pyz/Yves/Checkout/CheckoutDependencyProvider.php

+use Spryker\Yves\StepEngine\Dependency\Plugin\Form\SubFormPluginCollection;
+use SprykerEco\Shared\Billpay\BillpaySharedConfig;

+use SprykerEco\Yves\Billpay\Plugin\BillpayInvoiceSubFormPlugin;
+use SprykerEco\Yves\Billpay\Plugin\BillpayPaymentHandlerPlugin;

 class CheckoutDependencyProvider extends SprykerCheckoutDependencyProvider
 {
@@ -33,9 +37,8 @@ class CheckoutDependencyProvider extends SprykerCheckoutDependencyProvider
     const PLUGIN_SHIPMENT_HANDLER = 'PLUGIN_SHIPMENT_HANDLER';
     const PLUGIN_SHIPMENT_FORM_DATA_PROVIDER = 'PLUGIN_SHIPMENT_FORM_DATA_PROVIDER';

-    const PAYMENT_METHOD_HANDLER = 'PAYMENT_METHOD_HANDLER';
     const CUSTOMER_STEP_HANDLER = 'CUSTOMER STEP HANDLER';
-    const PAYMENT_SUB_FORMS = 'PAYMENT_SUB_FORMS';
+
     const CLIENT_BILLPAY = 'CLIENT_BILLPAY';

    /**
     * @param \Spryker\Yves\Kernel\Container $container
     *
     * @return \Spryker\Yves\Kernel\Container
     */
    protected function providePlugins(Container $container)
         $container = parent::providePlugins($container);


        $container[self::PAYMENT_SUB_FORMS] = function () {
            $paymentSubForms = new SubFormPluginCollection();
            $paymentSubForms-&gt;add(new BillpayInvoiceSubFormPlugin());
            return $paymentSubForms;
        };

        $container[self::PAYMENT_METHOD_HANDLER] = function () {
            $paymentMethodHandler =  new StepHandlerPluginCollection();
            $paymentMethodHandler-&gt;add(
                new BillpayPaymentHandlerPlugin(),
                BillpaySharedConfig::PAYMENT_METHOD_INVOICE
            );
            return $paymentMethodHandler;
        };

     ...

 /**
      * @param \Spryker\Yves\Kernel\Container $container
      *
      * @return \Spryker\Yves\Kernel\Container
      */
     protected function provideClients(Container $container)
     {

         // other clients ...     
              
         $container[self::CLIENT_BILLPAY] = function (Container $container) {
             return $container-&gt;getLocator()-&gt;billpay()-&gt;client();
         };
 
         return $container;
     }</code></pre>
                                                    </div>
                                                </div>
                                                <p>Now all we need to do is modify the Shippment step constructor:</p><pre><code class="language-php line-numbers">&lt;?php
/**
     * @param \Spryker\Client\Calculation\CalculationClientInterface $calculationClient
     * @param \Spryker\Client\Billpay\BillpayClientInterface $billpayClient
     * @param \Spryker\Yves\StepEngine\Dependency\Plugin\Handler\StepHandlerPluginCollection $shipmentPlugins
     * @param string $stepRoute
     * @param string $escapeRoute
     */
    public function __construct(
        CalculationClientInterface $calculationClient,
        BillpayClientInterface $billpayClient,
        StepHandlerPluginCollection $shipmentPlugins,
        $stepRoute,
        $escapeRoute
    ) {
        parent::__construct($stepRoute, $escapeRoute);

        $this-&gt;calculationClient = $calculationClient;
        $this-&gt;shipmentPlugins = $shipmentPlugins;
        $this-&gt;billpayClient = $billpayClient;
    }
 </code></pre>
                                                <p>and add a client call to the execute method:</p><pre><code class="language-php line-numbers"> &lt;?php
 /**
      * @param \Symfony\Component\HttpFoundation\Request $request
      * @param \Generated\Shared\Transfer\QuoteTransfer|\Spryker\Shared\Kernel\Transfer\AbstractTransfer|\Generated\Shared\Transfer\QuoteTransfer $quoteTransfer
      *
      * @return \Generated\Shared\Transfer\QuoteTransfer
      */
     public function execute(Request $request, AbstractTransfer $quoteTransfer)
     {
         $shipmentHandler = $this-&gt;shipmentPlugins-&gt;get(CheckoutDependencyProvider::PLUGIN_SHIPMENT_STEP_HANDLER);
         $shipmentHandler-&gt;addToDataClass($request, $quoteTransfer);
 
         $quoteTransfer = $this-&gt;calculationClient-&gt;recalculate($quoteTransfer);
 
         //added prescoring step
         if (Config::get(BillpayConstants::USE_PRESCORE)) {
            $this-&gt;billpayClient-&gt;prescorePayment($quoteTransfer);
         }
 
         return $quoteTransfer;
     }</code></pre>
                                                <h3>Twig Extension (Optional)</h3>
                                                <p>To populate the Billpay JS widget (<a href="https://techdocs.billpay.de/en/For_developers/JavaScript-Widget.html" target="_blank">https://techdocs.billpay.de/en/For_developers/JavaScript-Widget.html</a>) with data, use the Twig extension provided in the Billpay <span class="Generalbundle/module">(Undefined variable: General.bundle/module)</span>.</p>
                                                <p>To register the Twig extension:</p>
                                                <ul>
                                                    <li class="bullet_list" value="1">Add it to YvesBootstrap as follows: </li>
                                                </ul><pre><code class="language-php line-numbers">    protected function registerServiceProviders()
    {
        // other service providers ...
        $this-&gt;application-&gt;register(new TwigBillpayServiceProvider());
    }</code></pre>
                                                <p><strong>List of all available identifiers</strong>:</p>
                                                <table class="TableStyle-PatternedRows" style="mc-table-style: url('../../../resources/tablestyles/patternedrows.css');margin-left: 0;margin-right: auto;" cellspacing="0">
                                                    <col class="TableStyle-PatternedRows-Column-Regular" />
                                                    <col class="TableStyle-PatternedRows-Column-Regular" />
                                                    <col class="TableStyle-PatternedRows-Column-Regular" />
                                                    <thead>
                                                        <tr class="TableStyle-PatternedRows-Head-Header1">
                                                            <th class="TableStyle-PatternedRows-HeadE-Regular-Header1">Name	</th>
                                                            <th class="TableStyle-PatternedRows-HeadE-Regular-Header1">Description	</th>
                                                            <th class="TableStyle-PatternedRows-HeadD-Regular-Header1">Notes</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>salutation	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>Customer salutation</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">
                                                                <p>Taken from billing address</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>firstName</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>Customer first name</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>Taken from billing address</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>lastName	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>Customer last name</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">
                                                                <p>	Taken from billing address</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>address	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>Customer billing address street name</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>	i.e. Main Street</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>addressNo	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>Customer billing address street name extension</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">
                                                                <p>	i.e. 3a</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>zip	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>Billing address postal number</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>	i.e. 10317</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>city	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>Billing address city</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">
                                                                <p>	i.e. Berlin</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>phone	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>Customer telephone number</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>&#160;</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>dateOfBirth	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>Customer date of birth	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">
                                                                <p>Entered at payment step</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>cartAmount	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>Total value of cart items with discounts</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>	Equal to cart amount</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>orderAmount	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>Total value of order</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">
                                                                <p>&#160;</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>currency	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>currrency iso code	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>Defined in store configuration</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>language	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>Current user language</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">
                                                                <p>&#160;</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>countryIso3Code	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>Country iso3 code i.e deu	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>Defined in store configuration</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>countryIso2Code	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">
                                                                <p>Country iso2 code i.e de	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">
                                                                <p>Defined in store configuration</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>identifier	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">
                                                                <p>Unique session identifier	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>Autogenerated</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyB-Regular-LightRows">
                                                                <p>apiKey	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyB-Regular-LightRows">
                                                                <p>Billpay api key	</p>
                                                            </td>
                                                            <td class="TableStyle-PatternedRows-BodyA-Regular-LightRows">
                                                                <p>Defined in config under key BILLPAY_PUBLIC_API_KEY</p>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                <h3>Checking Your Setup</h3>
                                                <p>You should be able to see the Billpay invoice on payment step of your checkout step. If you receive the "method not available" message when you select<strong> Billpay invoice</strong> at the payment step, check the <var>spy_payment_billpay_api_log</var> table in your database for logs.</p>
                                                <h2>Zed</h2>
                                                <p>In Zed  <var>BillpaySaveOrderPlugin </var>has to be registered in the <var>CheckoutDependencyProvider</var>:</p><pre><code class="language-php line-numbers"> &lt;?php
 /**
     * @param \Spryker\Zed\Kernel\Container $container
     *
     * @return \Spryker\Zed\Checkout\Dependency\Plugin\CheckoutSaveOrderInterface[]
     */
    protected function getCheckoutOrderSavers(Container $container)
    {
        return [
            // other plugins ...
            
            new BillpaySaveOrderPlugin(),
        ];
    }</code></pre>
                                                <p>Then the following should be added in <var>OmsDependencyProvider</var>:</p><pre><code class="language-php line-numbers"> &lt;?php
/**
     * @param \Spryker\Zed\Kernel\Container $container
     *
     * @return \Spryker\Zed\Oms\Communication\Plugin\Oms\Condition\ConditionCollection
     */
    protected function getConditionPlugins(Container $container)
    {
        $collection = parent::getConditionPlugins($container);

        $collection-&gt;add(new IsInvoicePaidConditionPlugin(), 'Billpay/IsInvoicePaid');
        $collection-&gt;add(new IsPreauthorizedConditionPlugin(), 'Billpay/IsPreauthorized');
        $collection-&gt;add(new IsCancelledConditionPlugin(), 'Billpay/IsCancelled');
        $collection-&gt;add(new IsItemCancelledConditionPlugin(), 'Billpay/IsItemCancelled');

        return $collection;
    }

    /**
     * @param \Spryker\Zed\Kernel\Container $container
     *
     * @return \Spryker\Zed\Oms\Communication\Plugin\Oms\Command\CommandCollection
     */
    protected function getCommandPlugins(Container $container)
    {
        $collection = parent::getCommandPlugins($container);

        $collection-&gt;add(new PreauthorizeCommandPlugin(), 'Billpay/Preauthorize');
        $collection-&gt;add(new InvoiceCreatedCommandPlugin(), 'Billpay/InvoiceCreated');
        $collection-&gt;add(new CancelOrderCommandPlugin(), 'Billpay/CancelOrder');
        $collection-&gt;add(new CancelItemCommandPlugin(), 'Billpay/CancelItem');

        return $collection;
    }
 </code></pre>
                                                <h3>Check Your Settings</h3>
                                                <p>In your checkout process you can now see the Billapay as a payment method in the payment checkout step. If you log in to ZED, you will find the OMS state machine registered under <a href="http://zed.de.demoshop.local/oms/index/draw?process=BillpayInvoice01&amp;format=svg&amp;font=14&amp;state=" target="_blank">http://zed.de.demoshop.local/oms/index/draw?process=BillpayInvoice01&amp;format=svg&amp;font=14&amp;state=</a>. </p>
                                                <p>If the link does not work, just click <strong>Maintenance-&gt;OMS</strong> to list all registered OMS state machines.</p>
                                                <p>Basic state machine will look somewhat like this and you can use it as sample in your project. </p>
                                                <p><a class="MCPopupThumbnailLink MCPopupThumbnailPopup" href="../../../resources/images/basic_oms_state_machine.png" data-mc-popup-alt="State Machine"><img class="MCPopupThumbnail img imgThumbnail" data-mc-width="991" data-mc-height="1088" src="../../../resources/images/basic_oms_state_machine_thumb_0_48.png" alt="State Machine" title="Click Me" tabindex="" /></a>
                                                </p>
                                                <p>&#160;</p>
                                                <p><b>See also:</b>
                                                </p>
                                                <ul>
                                                    <li value="1"><a href="../../../Industry Partners/Payment/BillPay/integration_payment_billpay.htm" class="MCXref xref">Payment Integration - Billpay (BETA)</a>
                                                    </li>
                                                    <li value="2"><a href="../../../Industry Partners/Payment/BillPay/integration_payment_billpay_integration.htm" class="MCXref xref">Billpay Integration</a>
                                                    </li>
                                                </ul>
                                                <p>&#160;</p>
                                                <p><i>Last
review date:  Dec. 21st, 2017</i>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section><a data-close="true"></a>
                </div>
            </div>
            <script>/* <![CDATA[ */$(document).foundation();/* ]]> */</script>
        </div>
    </body>
</html>