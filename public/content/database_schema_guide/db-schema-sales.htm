<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" lang="en-us" xml:lang="en-us" class="_Skins_HTML5___Top_Navigation" data-mc-search-type="Stem" data-mc-help-system-file-name="Default.xml" data-mc-path-to-help-system="../../" data-mc-has-content-body="True" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic;Default" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-toc-path="Developer Guide|Database Schema Guide">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta charset="utf-8" />
        <meta name="description" content="" />
        <meta name="author" content="" /><title>Sales Schema</title>
        <link href="../../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" />
        <link href="../../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" />
        <link href="../../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" />
        <link href="../../Skins/Fluid/Stylesheets/MadCapSearch.Google.css" rel="stylesheet" />
        <link href="../../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" />
        <link href="../../Skins/Default/Stylesheets/Components/Tablet.css" rel="stylesheet" />
        <link href="../../Skins/Default/Stylesheets/Components/Mobile.css" rel="stylesheet" />
        <link href="../../Skins/Fluid/stylesheets/foundation.6.2.3.css" rel="stylesheet" />
        <link href="../../Skins/Fluid/stylesheets/styles.css" rel="stylesheet" />
        <link href="../../Skins/Fluid/stylesheets/tablet.css" rel="stylesheet" />
        <link href="../../Skins/Fluid/stylesheets/mobile.css" rel="stylesheet" />
        <link href="../resources/stylesheets/prism.css" rel="stylesheet" />
        <style>/*&lt;meta /&gt;*/

.button.topic-ratings-button
{
	-pie-background: transparent url('../../Skins/Default/Stylesheets/Images/star-full.png') no-repeat center center;
}

.button.separator-button
{
	-pie-background: linear-gradient(#ffffff, #ececec);
}

.button.edit-user-profile-button
{
	-pie-background: url('../../Skins/Default/Stylesheets/Images/edit-profile.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.print-button
{
	-pie-background: url('../../Skins/Default/Stylesheets/Images/printer.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.expand-all-button
{
	-pie-background: url('../../Skins/Default/Stylesheets/Images/expand.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.collapse-all-button
{
	-pie-background: url('../../Skins/Default/Stylesheets/Images/collapse.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.needs-pie
{
	behavior: url('../../Resources/Scripts/PIE-no-motw.htc');
}

</style>
        <link href="../resources/stylesheets/mainstyles.css" rel="stylesheet" />
        <link href="../resources/tablestyles/patternedrows.css" rel="stylesheet" />
        <script src="../../Resources/Scripts/custom.modernizr.js">
        </script>
        <script src="../../Resources/Scripts/jquery.min.js">
        </script>
        <script src="../../Resources/Scripts/require.min.js">
        </script>
        <script src="../../Resources/Scripts/require.config.js">
        </script>
        <script src="../../Resources/Scripts/foundation.6.2.3_custom.js">
        </script>
        <script src="../../Resources/Scripts/plugins.min.js">
        </script>
        <script src="../../Resources/Scripts/MadCapAll.js">
        </script>
        <script src="../../Resources/Scripts/MadCapSearch.Google.js">
        </script>
    </head>
    <body>
        <div class="foundation-wrap off-canvas-wrapper">
            <div class="off-canvas-wrapper-inner" data-off-canvas-wrapper="">
                <aside class="off-canvas position-right" id="offCanvas" data-off-canvas="" data-position="right" data-mc-ignore="true">
                    <ul class="off-canvas-drilldown vertical menu off-canvas-list" data-drilldown="" data-mc-back-link="Back" data-mc-css-tree-node-expanded="is-drilldown-submenu-parent" data-mc-css-tree-node-collapsed="is-drilldown-submenu-parent" data-mc-css-sub-menu="vertical menu slide-in-right is-drilldown-submenu" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="True" data-mc-include-back="True" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.drilldown" data-mc-toc="True">
                    </ul>
                </aside>
                <div class="off-canvas-content inner-wrap" data-off-canvas-content="">
                    <div data-sticky-container="" class="title-bar-container">
                        <nav class="title-bar tab-bar sticky" data-sticky="" data-options="marginTop:0" style="width:100%" data-sticky-on="small" data-mc-ignore="true">
                            <div class="middle title-bar-section outer-row clearfix">
                                <div class="menu-icon-container relative clearfix">
                                    <button class="menu-icon" data-toggle="offCanvas"><span></span>
                                    </button>
                                </div>
                            </div>
                            <div class="title-bar-layout outer-row">
                                <div class="logo-wrapper"><a class="logo" href="../home.htm" alt="Logo"></a>
                                </div>
                                <div class="navigation-wrapper nocontent">
                                    <ul class="navigation clearfix" data-mc-css-tree-node-has-children="has-children" data-mc-css-sub-menu="sub-menu" data-mc-expand-event="mouseenter" data-mc-top-nav-menu="True" data-mc-max-depth="3" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                        <li class="placeholder" style="visibility:hidden"><a>placeholder</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="nav-search-wrapper">
                                    <div class="nav-search row">
                                        <form>
                                            <div id="fGlgUcvg4UaqRDdcIH_OYQ" class="search-bar search-bar-container needs-pie">
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </nav>
                    </div>
                    <section class="main-section">
                        <div class="row outer-row sidenav-layout">
                            <div class="sidenav-wrapper">
                                <div class="sidenav-container">
                                    <ul class="off-canvas-accordion vertical menu sidenav" data-accordion-menu="" data-mc-css-tree-node-expanded="is-accordion-submenu-parent" data-mc-css-tree-node-collapsed="is-accordion-submenu-parent" data-mc-css-sub-menu="vertical menu accordion-menu is-accordion-submenu nested" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="False" data-mc-include-back="False" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.accordionMenu" data-mc-toc="True" data-mc-side-nav-menu="True">
                                    </ul>
                                </div>
                            </div>
                            <div class="body-container" data-mc-content-body="True">
                                <script src="../resources/prism.js">
                                </script>
                                <div class="search-container">
                                    <form>
                                        <div id="ozIz_SQA1kKmrljxN0gerQ" class="search-bar search-bar-container needs-pie _Skins_SearchTopics mc-component">
                                        </div>
                                    </form>
                                </div>
                                <div class="row collapse">
                                    <div class="top-bar">
                                        <div class="nocontent">
                                            <div class="MCBreadcrumbsBox_0 breadcrumbs" data-mc-breadcrumbs-divider=" &gt; " data-mc-breadcrumbs-count="3" data-mc-toc="True"><span class="MCBreadcrumbsPrefix">You are here: </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="topic-layout">
                                        <div>
                                            <div class="side-menu">
                                                <div data-sticky-container="" id="kaY-IvMQzEmHWkfWZ__WiQ">
                                                    <div class="sticky sticky-menu" style="width:100%" data-sticky="" data-top-anchor="kaY-IvMQzEmHWkfWZ__WiQ:top" data-bottom-anchor="contentBody:bottom" data-sticky-on="small" data-scroll-container-on="small">
                                                        <ul class="nocontent menu _Skins_SideMenu mc-component" data-mc-is-context-sensitive="True" data-mc-linked-toc="Data/Tocs/master.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="side-menu">
                                                <div class="buttons popup-container clearfix topicToolbarProxy _Skins_TopicToolbar mc-component nocontent" style="mc-topic-toolbar-items: ;">
                                                    <div class="button-group-container-left">
                                                        <div class="button-group star-buttons loading feedback-topic-required">
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                        </div>
                                                        <div class="button-separator feedback-topic-required">
                                                        </div>
                                                        <button class="button feedback-required login-button" id="normalLoginBtn" data-state1-class="login-button" data-state2-class="edit-user-profile-button" title="Login" data-state1-title="Login">
                                                            <img src="../../Skins/Default/Stylesheets/Images/transparent.gif" alt="login" />
                                                        </button>
                                                        <button class="button needs-pie print-button" title="Print">
                                                            <img src="../../Skins/Default/Stylesheets/Images/transparent.gif" alt="print" />
                                                        </button>
                                                        <button class="button needs-pie expand-all-button" data-state1-class="expand-all-button" data-state2-class="collapse-all-button" data-state2-title="Collapse all" title="Expand all" data-state1-title="Expand all">
                                                            <img src="../../Skins/Default/Stylesheets/Images/transparent.gif" alt="expand all" />
                                                        </button>
                                                    </div>
                                                </div>
                                                <h1>Sales Schema</h1>
                                                <h2 style="font-weight: bold;"><a name="Orders"></a>Orders</h2>
                                                <h3 style="color: #e35d44;"><a name="Sales"></a><span style="color: #e35d44;">Sales Order with Items</span>
                                                </h3>
                                                <p>Spryker saves orders with line items. There are three general approaches:</p>
                                                <ol>
                                                    <li value="1">There is one Sales Order Item for every sold product to the Sales Order. Even when the same product was sold several times. This way we can have a clear state per item.</li>
                                                    <li value="2">All data that is necessary to process the order is copied over from other tables. So we clearly separate dynamic data (like the current name of a product) from static data (like the name of the product at the moment when it was sold).</li>
                                                    <li value="3">Prices are saved in an explicit way so that all numbers are fixed and there is no reason for a later re-calculation.</li>
                                                </ol>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/sales-order-item.png" />
                                                </p>
                                                <ul>
                                                    <li value="1"><b>Structure</b>:</li>
                                                    <ul>
                                                        <li value="1">The <b>Sales Order</b> contains only high-level information for the direct communication with the customer (e.g. the name).</li>
                                                        <li value="2"><i>order_reference</i> - Order reference which is in an ascending order but not linear growing. This reference must be used for all external communications instead of the auto-increment ID to avoid conclusions.</li>
                                                        <li value="3"><i>is_test</i> - This field was supposed to mark test orders so that the order can be processed in the production environment but all external communication is mocked or also switched to test mode. <p class="note">This feature is currently not functional.</p></li>
                                                        <li value="4"><i>store</i> - The name of the Store where the order was placed</li>
                                                        <li value="5"><i>price_mode</i> - This field shows if the order was calculated in a net or gross price mode.</li>
                                                    </ul>
                                                    <li value="2">The <b>Sales Order Item</b> contains all item-related information like the SKU and product name.</li>
                                                    <ul>
                                                        <li value="1"><i>sku</i> - SKU of the product. This is a soft relation to the Concrete Product to avoid cross-boundary coupling.</li>
                                                        <li value="2"><i>quantity</i> - Quantity of "same" products. Per default, this value is "1" so that we save one Sales Order Item per item sold. But in case of non-Splittable Products, we can use a higher value here. We may also use higher quantities for very high numbers to avoid performance problems.</li>
                                                        <ul>
                                                            <li value="1">"Same product" means products that have the same grouping key which is a hash of the SKU and the Product Options (see class <i>SkuGroupKeyPlugin</i>). The key is also saved in the field <i>group_key</i></li>
                                                        </ul>
                                                        <li value="3"><i>is_quantity_splitable</i> - This flag declares if the quantity can be split (e.g. in case of partial cancelations). <p class="note">It is currently not possible to realize splits with Sales Order Items that have a quantity bigger than "1".</p></li>
                                                    </ul>
                                                    <li value="3">The Sales Order Item also holds information that is injected from other features, especially the quantity and amount of metadata from the <b>Measurement and Packaging Unit</b> features.</li>
                                                </ul>
                                                <h3><a name="Customer"></a><span style="color: #e35d44;">Customer Data</span>
                                                </h3>
                                                <p>The Sales Order contains a copy of the Customer data so that it is not affected if the Customer makes changes.</p>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/customer-data.png" />
                                                </p>
                                                <p><b>Structure</b>:</p>
                                                <ul>
                                                    <li value="1">The Sales Order has a relation to the Locale which was used during the checkout so that the same locale can be used for communication.</li>
                                                    <li value="2">The Sales Order has a shipping and a billing address.</li>
                                                </ul>
                                                <h3><a name="Sales2"></a><span style="color: #e35d44;">Sales Bundles and Options</span>
                                                </h3>
                                                <p>See description of the <a href="db-schema-catalog.htm#Product">Product Bundle</a> and <a href="db-schema-catalog.htm#Product2">Product Option</a> schemas for more details.</p>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/sales-bundles-options.png" />
                                                </p>
                                                <p><b>Structure</b>:</p>
                                                <ul>
                                                    <li value="1"><b>Bundles</b>:</li>
                                                    <ul>
                                                        <li value="1">Bundled products are saved as regular Sales Order Items.</li>
                                                        <li value="2">The Product Bundle itself is not represented as a Sales Order Item and is placed into a special table.</li>
                                                    </ul>
                                                    <li value="2"><b>Options</b>:</li>
                                                    <ul>
                                                        <li value="1">Each Sales Order Item can have multiple Product Options.</li>
                                                        <li value="2">Each Option contains the group name (e.g. "Insurance") and the value (e.g. "1 year").</li>
                                                    </ul>
                                                </ul>
                                                <h3><a name="Expenses"></a><span style="color: #e35d44;">Expenses</span>
                                                </h3>
                                                <p>Sales Orders and Sales Order Items can have additional costs. Typically this is the price for the Shipment that is attached to Sales Order.</p>
                                                <p class="note">Currently, Spryker only supports expenses for the whole order and not per item.</p>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/expenses.png" />
                                                </p>
                                                <p><b>Structure</b>:</p>
                                                <ul>
                                                    <li value="1">The order can have several expenses (typically none or one).</li>
                                                    <li value="2">Expenses have a relation to a Shipment which is the main (and only) use case.</li>
                                                </ul>
                                                <h3><a name="Discount"></a><span style="color: #e35d44;">Discounts</span>
                                                </h3>
                                                <p>See Discount Schema for a full description:</p>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/discount.png" />
                                                </p>
                                                <p><b>Structure</b>:</p>
                                                <ul>
                                                    <li value="1">Discounts are distributed to all objects.</li>
                                                    <li value="2">Each object can have multiple discounts.</li>
                                                    <li value="3">Discounts are saved with the name, amount, used code (if any) and metadata (e.g. "is_refundable") to all objects where discounts can be applied (Order, Item, Option, and Expense).</li>
                                                </ul>
                                                <h3><a name="Payments"></a><span style="color: #e35d44;">Payments</span>
                                                </h3>
                                                <p>Orders can be paid with none, one or multiple payments. Each payment is identified by a provider (e.g. Payone) and a method (e.g. Creditcard)</p>
                                                <table style="width: 100%;mc-table-style: url('../resources/tablestyles/patternedrows.css');" class="TableStyle-PatternedRows" cellspacing="0">
                                                    <col class="TableStyle-PatternedRows-Column-Regular" />
                                                    <col class="TableStyle-PatternedRows-Column-Regular" />
                                                    <thead>
                                                        <tr class="TableStyle-PatternedRows-Head-Header1">
                                                            <th class="TableStyle-PatternedRows-HeadE-Regular-Header1">Use case</th>
                                                            <th class="TableStyle-PatternedRows-HeadD-Regular-Header1">Payment Method(s)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">The customer pays the whole order with a discount</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">None</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">The customer pays the order with a credit card</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">Credit card</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">The customer pays the order with two credit cards</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">Credit card A Credit card B</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyB-Regular-DarkerRows">The customer pays the order with a credit card and a gift card</td>
                                                            <td class="TableStyle-PatternedRows-BodyA-Regular-DarkerRows">Credit card Gift card</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/payments.png" />
                                                </p>
                                                <p><b>Structure</b>:</p>
                                                <ul>
                                                    <li value="1">Payments are related to Sales Orders.</li>
                                                    <li value="2">The amount field contains the amount which was paid by a payment method (which is important for refunds).</li>
                                                </ul>
                                                <h2><a name="OMS"></a><b>OMS Process and States</b>
                                                </h2>
                                                <h3><a name="Sales3"></a><span style="color: #e35d44;">Sales Order Item States and Process</span>
                                                </h3>
                                                <p>Spryker uses State Machine to process orders. Every Sales Order Item has a distinct State and belongs to a Process. The State Machine itself is modeled via XML files and therefore not visible in the schema.</p>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/sales-order-item-states-process.png" />
                                                </p>
                                                <p><b>Structure</b>:</p>
                                                <ul>
                                                    <li value="1">Each Sales Order Item is related to exactly one Process and one State (e.g. State: "payment pending" in Process: "PrePayment").</li>
                                                    <li value="2"><i>spy_oms_order_item_state_history</i> tracks the history of state per item.</li>
                                                    <li value="3">The Sales Order Item has a <i>last_state_change</i> field to avoid expensive lockups on the history table.</li>
                                                    <li value="4">State names are filled automatically when they appear the first time. Any manual change of this table can lead to operational problems because the States are matched via the name field.</li>
                                                </ul>
                                                <h3><a name="Transiti"></a><span style="color: #e35d44;">Transition Log</span>
                                                </h3>
                                                <p class="info">When something goes wrong in the fulfillment of an order then it's a good idea to have a log with all transitions.</p>
                                                <p class="note">This feature is not 100% reliable at the moment and may result in performance problems. The log can be retrieved in Zed UI via a hidden URL: /oms/log?id-order=1</p>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/transition-log.png" />
                                                </p>
                                                <p><b>Structure</b>:</p>
                                                <ul>
                                                    <li value="1">The log table holds all relevant information and is related to the Sales Order and the Sales Order Item.</li>
                                                </ul>
                                                <h3><a name="State"></a><span style="color: #e35d44;">State Machine Lock</span>
                                                </h3>
                                                <p class="info">The State Machine cannot be executed in parallel for the same Sales Order. For this reason, there is a lock with a configurable TTL.</p>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/state-machine-lock.png" />
                                                </p>
                                                <h2><a name="Quote"></a><b>Quote</b><![CDATA[
        ]]></h2>
                                                <p class="info">The quote object contains the Cart and all user input from the Checkout (like Addresses). When the Quote is persisted in the database then we filter out all data which does not belong the Cart.</p>
                                                <h3><a name="Persiste"></a><span style="color: #e35d44;">Persisted Quote (Multi-Cart per Customer)</span>
                                                </h3>
                                                <p>Customers can have more than one cart and they have the option to keep the cart after checkout.</p>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/persisted-quote.png" />
                                                </p>
                                                <p><b>Structure</b>:</p>
                                                <ul>
                                                    <li style="font-style: normal;" value="1">A Quote has a name, belongs to a Customer is only valid in the scope of a Store</li>
                                                    <li style="font-style: normal;" value="2">A Customer can have multiple Quotes but only one of them is marked as <i>is_default</i>. This is a soft relation via <i>customer_reference</i>.</li>
                                                    <li style="font-style: normal;" value="3"><i>Quote::quote_data</i> - Serialized quote object which contains only the cart data. Other checkout information is filtered out before the data is saved.</li>
                                                </ul>
                                                <h3><a name="Shared"></a><span style="color: #e35d44;">Shared Quotes (Carts)</span>
                                                </h3>
                                                <p class="info">Carts can be shared among Company Users.</p>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/shared-quotes.png" />
                                                </p>
                                                <h2><a name="Sales4"></a><b>Sales Order Prices</b>
                                                </h2>
                                                <p>All calculated price values are stored to the order. The assumption is that this information is not changed afterward except for the edge case when the whole order is changed before the payment ("Recalculation").</p>
                                                <h3><a name="Overview"></a><span style="color: #e35d44;">Overview</span>
                                                </h3>
                                                <p>It's important to obey the Sales Order's <i>price_mode</i> that defines if the calculation was executed in net or gross price mode.</p>
                                                <p class="info">You can have a look inside the calculation when you add some products to the cart and then open this URL in the shop: <i>/calculation/debug</i></p>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/sales-order-prices.png" />
                                                </p>
                                                <p>In general, there are several types of fields:</p>
                                                <ul>
                                                    <li value="1">Plain prices which are saved in the lowest unit (e.g. "Cent").</li>
                                                    <li value="2">Amounts which can be changed by user actions (e.g. canceled_amount).</li>
                                                    <li value="3">Aggregated values which are summed up from related objects (for instance the price_to_pay_aggregation of a Sales Order Item contains the price of the item plus the price of all options minus the applied discount values).</li>
                                                    <li value="4">Totals which are applied to the Sales Order.</li>
                                                </ul>
                                                <p>Prices are attached to different objects like Products, Expenses, Options, ...</p>
                                                <p>All prices in the are the line prices (so multiplied by the related quantity).</p>
                                                <table style="width: 100%;mc-table-style: url('../resources/tablestyles/patternedrows.css');" class="TableStyle-PatternedRows" cellspacing="0">
                                                    <col class="TableStyle-PatternedRows-Column-Regular" />
                                                    <col class="TableStyle-PatternedRows-Column-Regular" />
                                                    <col class="TableStyle-PatternedRows-Column-Regular" />
                                                    <thead>
                                                        <tr class="TableStyle-PatternedRows-Head-Header1">
                                                            <th class="TableStyle-PatternedRows-HeadE-Regular-Header1">Fields</th>
                                                            <th class="TableStyle-PatternedRows-HeadE-Regular-Header1">Description</th>
                                                            <th class="TableStyle-PatternedRows-HeadD-Regular-Header1">Calculation</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">tax_rate</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">The tax rate of the object loaded from DB</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">---</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">tax_amount_full_aggregation</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">The sum of the tax_amount of all related objects</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>∑tax_amount </p>
                                                                <p>+ ∑ItemExpense::tax_amount</p>
                                                                <p>+ ∑ProductOption::tax_amount</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">tax_amount</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">Tax amount of the object</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">(gross_price - discount_amount_aggregation) * tax_rate / (1+tax_rate)</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">subtotal_aggregation</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">The price of the item with product options but without discounts and expenses.</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>gross_price	</p>
                                                                <p>+ product_option_price_aggregation	</p>
                                                                <p>+ expense_price_aggregation</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">refundable_amount</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">The amount that can be canceled for the item (with options, expensed and discounts), Identical with price to pay when the order is created and changed later.</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">price_to_pay_aggregation - canceled_amount</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">product_option_price_aggregation</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">The sum of the price of all related options of a Sales Order Item</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">∑ProductOption::gross_price</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">price_to_pay_aggregation</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">The price to pay for the customer. This is used as the initial refund amount for the order. Usually this is not shown in cart.</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">
                                                                <p>gross_price	</p>
                                                                <p>+ product_option_price_aggregation	</p>
                                                                <p>+ expense_price_aggregation	</p>
                                                                <p>- discount_amount_full_aggregation</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">price</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">The (original) price of the object. Either net or gross.</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">net_price OR gross_price</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">net_price</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">New price of the object from the database</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">---</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">gross_price</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">Gross price of the object from the database</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">---</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">expense_price_aggregation</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">The sum of the price of all related item-expenses of a Sales Order Item</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">∑ItemExpense::gross_price</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">discount_amount_full_aggregation</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">The sum of the amounts of all related discounts. Example: the discounted value of a Sales Order Item is the sum of the values of all applied discounts on the item itself and all related options.</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>Item:discount_amount_aggregation	</p>
                                                                <p>+ ∑ProductOption::discount_amount_aggregation	</p>
                                                                <p>+ ∑ItemExpense::discount_amount_aggregation</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">discount_amount_aggregation</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">The sum of the unit_amount of all directly related discounts</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">∑Discount::amount</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyB-Regular-DarkerRows">canceled_amount</td>
                                                            <td class="TableStyle-PatternedRows-BodyB-Regular-DarkerRows">The amount that was canceled. This is usually either 0 or equal with the price_to_pay_aggregation but can also be any other value in between.</td>
                                                            <td class="TableStyle-PatternedRows-BodyA-Regular-DarkerRows">User Input</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                <h3><a name="Order"></a><span style="color: #e35d44;">Order Totals</span>
                                                </h3>
                                                <p>Totals are sums of already aggregated values. They are shown in the checkout and in the invoices.</p>
                                                <p>
                                                    <img src="../resources/images/databaase_schema_guide/order-totals.png" />
                                                </p>
                                                <table style="width: 100%;mc-table-style: url('../resources/tablestyles/patternedrows.css');" class="TableStyle-PatternedRows" cellspacing="0">
                                                    <col class="TableStyle-PatternedRows-Column-Regular" />
                                                    <col class="TableStyle-PatternedRows-Column-Regular" />
                                                    <col class="TableStyle-PatternedRows-Column-Regular" />
                                                    <thead>
                                                        <tr class="TableStyle-PatternedRows-Head-Header1">
                                                            <th class="TableStyle-PatternedRows-HeadE-Regular-Header1">Field</th>
                                                            <th class="TableStyle-PatternedRows-HeadE-Regular-Header1">Description</th>
                                                            <th class="TableStyle-PatternedRows-HeadD-Regular-Header1">Calculation</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">subtotal</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">Subtotal that is shown in cart and used for invoices</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">
                                                                <p>∑Item::sum_aggregation	</p>
                                                                <p>- ∑Item::canceled_amount</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">order_expense_total</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">Total order expenses (~Sum of all applied shipment costs)</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">∑Expense::gross_price</td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">discount_total</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">Sum of all discount values</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">
                                                                <p>∑Item::discount_amount_full_aggregation	</p>
                                                                <p>+ ∑Expense::discount_amount_aggregation</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">refund_total</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">Totally refunded amount</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>∑Item::refundable_amount	</p>
                                                                <p>+ ∑Expense::refundable_amount</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">canceled_total</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-LightRows">Total amount which was canceled</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-LightRows">
                                                                <p>∑Item::cancelled_amount	</p>
                                                                <p>+ ∑Expense::cancelled_amount</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-DarkerRows">
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">tax_total</td>
                                                            <td class="TableStyle-PatternedRows-BodyE-Regular-DarkerRows">Total tax amount of the order</td>
                                                            <td class="TableStyle-PatternedRows-BodyD-Regular-DarkerRows">
                                                                <p>∑Item::tax_amount_full_aggregation </p>
                                                                <p>+ ∑Expense::tax_amount</p>
                                                            </td>
                                                        </tr>
                                                        <tr class="TableStyle-PatternedRows-Body-LightRows">
                                                            <td class="TableStyle-PatternedRows-BodyB-Regular-LightRows">grand_total</td>
                                                            <td class="TableStyle-PatternedRows-BodyB-Regular-LightRows">Final price that needs to be paid</td>
                                                            <td class="TableStyle-PatternedRows-BodyA-Regular-LightRows">
                                                                <p>∑Item::price_to_pay_aggregation	</p>
                                                                <p>- ∑Item::cancelled_amount	</p>
                                                                <p>+ ∑Expense::price_to_pay_aggregation	</p>
                                                                <p>- ∑Expense::cancelled_amount</p>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section><a data-close="true"></a>
                </div>
            </div>
            <script>/* <![CDATA[ */$(document).foundation();/* ]]> */</script>
        </div>
    </body>
</html>